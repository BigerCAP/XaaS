====== 用s3cmd挂载云储存服务器 ======

s3cmd是亚马逊s3的一个命令行工具，稍作修改可以用在国内的云存储。服务器Centos，如果有**epel源**的话，可以直接 
<code>yum install s3cmd</code>
或者直接去SF下载，传送 > [[http://sourceforge.net/projects/s3tools/files/s3cmd/|s3cmd Projects]]
\\ 解压软件包，执行./s3cmd --configure，如果没有python-dateutil，就会报以下错误。
<html><pre style="background: #E6E9ED;border-left: 4px solid #7AD03A;color: #222;font: 12px/20px Consolas,"Courier New",Courier,monospace;margin: 0 0 20px;padding: 10px 12px;white-space: pre-wrap;word-wrap: break-word;margin-bottom: 25px;overflow:hidden;">
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
ImportError trying to import dateutil.parser.
Please install the python dateutil module:
$ sudo apt-get install python-dateutil
  or
$ sudo yum install python-dateutil
  or
$ pip install python-dateutil
!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!!
</pre></html>

我系统centos，这时候执行yum install python-dateutil，然后在测试。
\\ yum install安装此软件的，然后：
<code>s3cmd --configure</code>
用源码包安装的，需要去软件解压目录执行,类似windows下的免安装绿色软件。
<code>./s3cmd --configure</code>

<html><pre style="background: #E6E9ED;border-left: 4px solid #7AD03A;color: #222;font: 12px/20px Consolas,"Courier New",Courier,monospace;margin: 0 0 20px;padding: 10px 12px;white-space: pre-wrap;word-wrap: break-word;margin-bottom: 25px;overflow:hidden;">
Enter new values or accept defaults in brackets with Enter.
Refer to user manual for detailed description of all options.

Access key and Secret key are your identifiers for Amazon S3. Leave them empty for using the env variables.
Access Key: 这里输入AK
Secret Key: 这里输入SK
Default Region [US]: CN  #默认美国市区，可更改

Encryption password is used to protect your files from reading
by unauthorized persons while in transfer to S3
Encryption password: 	#我理解为一种链接对话加密
Path to GPG program [/usr/bin/gpg]: GPG路劲，没修过可直接回车 

When using secure HTTPS protocol all communication with Amazon S3
servers is protected from 3rd party eavesdropping. This method is
slower than plain HTTP, and can only be proxied with Python 2.7 or newer
Use HTTPS protocol [No]:  是否使用https，默认NO

On some networks all internet access must go through a HTTP proxy.
Try setting it here if you can't connect to S3 directly
HTTP Proxy server name:  是否使用代理，默认空

New settings:
  Access Key: 显示你的AK
  Secret Key: 显示你的SK
  Default Region: CN
  Encryption password: 
  Path to GPG program: /usr/bin/gpg
  Use HTTPS protocol: False
  HTTP Proxy server name: 
  HTTP Proxy server port: 0

Test access with supplied credentials? [Y/n] n	#是否测试这个链接

Save settings? [y/N] y		#是否保存文件
Configuration saved to '/root/.s3cfg'		#保存文件地址

</pre></html>
按照提示，填入密匙，其它选项一路默认回车即可，后面问是不是要测试连接的时候选 No（因为s3cmd在修改前默认连接是亚马逊s3），
然后保存，程序会在用户跟目录下生成一个隐藏文件，我们要修改这个配置文件：

	<code>vim ~/.s3cfg</code>
找到“host_base =”和“host_bucket =”这两行，修改至如下：

	<code>host_base = s3.domain.com
	host_bucket = %(bucket)s.s3.domain.com</code>
好了，现在试试s3cmd的一个常用命令：

	<code>s3cmd ls</code>

----

如果可以看见你在对象云存储里建立的容器，那表示配置成功，另外一些常用的命令如下，用**s3cmd --help**可以查看

^ 创建容器 |%%  s3cmd mb s3://BUCKET %%|
^ 删除容器 |%%  s3cmd rb s3://BUCKET %%|
^ 查看容器内的文件 |%%  s3cmd ls s3://BUCKET/path/ %%|
^ 查看所有容器内的所有文件，我测试过只能显示一层目录 |%%  s3cmd la %%|
^ 把文件从本地上传至云存储的命令 |%%  s3cmd put FILE [FILE...] s3://BUCKET[/PREFIX] %%|
^ 从云存储下载文件到本地 |%%  s3cmd get s3://BUCKET/OBJECT LOCAL_FILE %%|
^ 删除容器内的特定文件 |%%  s3cmd del s3://BUCKET/OBJECT %%|
^ 如果要删除容器类的整个目录，可以加参数 -r -f |%% s3cmd del -r -f s3://容器/目录/ %%|
^ 查看容器所占空间 |%% s3cmd du [s3://BUCKET[/PREFIX]] %%|
^ 查看容器或者文件的属性 |%% s3cmd info s3://BUCKET[/OBJECT] %%|
^ 云存储中的文件复制命令 |%% s3cmd cp s3://BUCKET1/OBJECT1 s3://BUCKET2[/OBJECT2] %%|
^ 移动文件 |%% s3cmd mv s3://BUCKET1/OBJECT1 s3://BUCKET2[/OBJECT2] %%|
^ 把本地目录同步到云存储或者从云存储同步到本地 |%% s3cmd sync LOCAL_DIR s3://BUCKET[/PREFIX] or ^ s3://BUCKET[/PREFIX] LOCAL_DIR %%|

----

同步本地至云存储，并在云端删除已经从本地删除的文件
<code> s3cmd sync --delete-removed /path/ s3://bucket/path/ </code>
如果怕错删除，可以再加参数 --dry-run，它只列出--delet-removed将要删除的文件，但并不会真正的删除
<code> s3cmd sync --dry-run --delete-removed /path/ s3://bucket/path/ </code>
sync命令默认是要校检本地文件和云存储中文件的md5值的，如果不想校检只同步新文件，可以加 --skip-existing
<code> s3cmd sync --skip-existing /path/ s3://bucket/path/ </code>
还有 --exclude（不包含） 和 --include（包含）参数
<code> s3cmd sync --exclude '*.txt' --include 'dir2/*' . s3://bucket/path/ </code>

常用的命令就以上了，复杂一点的可以去啃s3cmd官方文档。

云存储可以用来存储网站上的静态内容的：.css、.js、.jpg一类。这类文件加入Cache-Control header 可以减少请求数量和流量，参数是 --add-header，命令如下：

<code> s3cmd put --add-header='Cache-Control:max-age=31536000' -M -r jpg_folder s3://domain.com/ </code>

如果想进一步降低流量消耗，可以考虑gzip压缩css和js文件，毕竟流量在云存储里是算钱的，但貌似云存储服务器端并不支持gzip压缩，
所以我们要预先压缩文件。我的做法是先 "gzip -9" 压缩css文件得到 *.css.gz ，
再批量重命名 *.css.gz 为 *.css，最后上传 *.css 文件。这时需要给已经压缩过的文件加 Content-encoding header，
否则浏览器读不出来，命令如下：

<code> s3cmd put --add-header='Cache-Control:max-age=31536000' --add-header='Content-encoding:gzip' -M *.css s3://domain.com/css/ </code>    


----


{{tag>s3cmd Amazon epel 对象云储存}}